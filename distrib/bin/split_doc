#!/bin/sh

LINK=$1

if [ X$LINK = X ]
then
	echo "$0: require one argument (dst to symlink)"
	exit 1
fi

GEN="perl distrib/bin/html_split.pl"

if [ -d var/db ]
then
	echo "var/db exists! STOP "; 
	exit 1
else
	rm -f var/db
	ln -s $LINK var/db
fi

tmp=/tmp/splitdoc$$

trap "rm -f $tmp" 0 1 3 15

(cd var/html/; echo * | tr ' ' '\012' |perl -nle 'print unless -l $_'> $tmp )

for dir in `cat $tmp`
do
   if [ -d var/html/$dir ]	
   then
	if [ ! -d var/db/$dir -o \
	var/html/$dir/index.html -nt var/db/$dir/.touch ]
	then
	   $GEN -R ../../$dir/ -U http://www.fml.org/fml/$dir \
		-D var/db/$dir var/html/$dir/[i0-9]*html
	fi

	touch var/db/$dir/.touch

   elif [ -f var/html/$dir ]
   then
	rm -f var/db/$dir
	cp -p var/html/$dir var/db/$dir
   fi
done

echo ""
echo "perl distrib/bin/find_older.pl |perl -nple unlink"
echo ""
perl distrib/bin/find_older.pl |perl -nple unlink

exit 0;
