GEN_DOC () {

	echo "Generating Plain Doc"
	(chdir $FML; $MAKE plaindoc);

	echo "Generating WWW Doc"
	(
		echo "Making WWW pages of doc/smm/op => var/html/op";
		chdir $FML; 
		make htmldoc 
	)
}


GEN_WWW () {
	echo "ReGenerating WWW Search Environment";
	(cd $FML; make syncwww search)
}


GEN_LIBRARY () {

	#perl cf/config -cn -I cf/compat.ignore |\
	#sed 's/sapporo.iij.ad.jp/phys.titech.ac.jp/' > proc/libcompat_cf1.pl

	echo  " ";
	echo  "Generating libkern.pl  ";
	sed '/^$Rcsid/,/MAIN ENDS/d' kern/fml.pl > proc/libkern.pl

}


INCREMENT_VERSION () {
	(chdir var/run; version.pl)
	echo " "; 
}


CLEAN_UP_SNAPSHOT () {
	echo " "; echo "rm -f $UPDIR/fml-*.gz"
	rm -f $UPDIR/fml-*.gz
	echo " ";
}


MKDIR_DISTRIBUTION () {

	if [ -d $UPDIR/distrib ]
	then 
		echo ""
		echo "      mv $UPDIR/distrib $UPDIR/FML/distrib.$BAKID" 
		mv $UPDIR/distrib $UPDIR/FML/distrib.$BAKID
		echo ""
	fi

	echo make a directory $UPDIR/distrib; 
	mkdir $UPDIR/distrib;

	for dir in `cat $DIRECTORY_LIST`
	do
		echo "mkdir $UPDIR/distrib/$dir"
		mkdir $UPDIR/distrib/$dir
	done

	(chdir $UPDIR/distrib; ln -s contrib lib )
	(chdir $UPDIR/distrib/doc; ln -s ../drafts drafts )
}


COPY_DOCS () {
   (
	echo " "; echo "Copying Documents (doc/ri)...";
	cd var/doc;
	cp -p $DOC $UPDIR/distrib/doc;
   )
   (
	echo " "; echo "Copying 'contrib' Documents (doc/master)...";
	cp -p $DOC_CONTRIB $UPDIR/distrib/doc;
   )

   (
	echo " "; echo "Copying Documents (doc/smm/)...";
	(chdir doc; tar cf - smm/*.wix smm/app/*wix) |\
	(chdir $UPDIR/distrib/doc; tar xvf - )

	perl distrib/bin/fix-wix.pl -R doc/smm/op.wix \
	> $UPDIR/distrib/doc/smm/op.wix

	echo " "; echo "Copying Documents (doc/ri/)...";
	(chdir doc; tar cf - ri/*.wix) |\
	(chdir $UPDIR/distrib/doc; tar xvf - ) 
   )

   # http
   echo " ";

   CPP="cpp -P -DDIST "
   HTML_DIR=$UPDIR/distrib/doc/html
   $CPP -DJAPANESE doc/html/index.html > $HTML_DIR/index-j.html
   $CPP -UJAPANESE doc/html/index.html > $HTML_DIR/index-e.html
   cp doc/html/release-index.html $HTML_DIR/index.html
   cp doc/html/fml.css $HTML_DIR/

   (
	chdir var/html;
	echo "rsync -av [A-Z]* $UPDIR/distrib/doc/html/"
	rsync -av [A-Z]* $UPDIR/distrib/doc/html/
   )	

}


COPY_SOURCES () {
	archsrc=/tmp/archsrc$$


	echo ""; echo "Copying Main Sources ... ";
	cp -p $SOURCES 		$UPDIR/distrib/
	cp -p $DRAFTS_SOURCES   $UPDIR/distrib/drafts
	cp -p $C_SOURCES	$UPDIR/distrib/C
	cp -p $PERL_SOURCES	$UPDIR/distrib/src

	find sys -type f -print|\
	egrep -v '*~|/RCS' |sed 's#proc/##' > $archsrc

	# removed proc/arch (98/08/01)
	# (chdir proc; tar cf - `cat $archsrc`)|\
	# (chdir $UPDIR/distrib/src; tar xvf -)

	echo "   copying $ARCH_SOURCE -> $UPDIR/distrib/"
	find $ARCH_SOURCES -type f -print|\
	egrep -v '*~|/RCS|/FVS|/CVS|WINDOWS_NT4/docs|WINDOWS_NT4/lib|WINDOWS_NT4.old|Makefile' > $archsrc

	tar cf - `cat $archsrc`|(chdir $UPDIR/distrib; tar xvf -)

	# cf
	echo " "; echo "cf/ ...";
	(cd cf;
	cp -p `find . -type f|egrep -v 'sapporo|beth|RCS|FVS'|grep -v '~'` \
	$UPDIR/distrib/cf;
	)

	# bin
	echo " "; echo "Copying bin/ ";
	cp -p $BIN_SOURCES $UPDIR/distrib/bin
	echo "chmod 755 bin/\*";
	chmod 755 $UPDIR/distrib/bin/*

	# sbin
	echo " "; echo "Copying sbin/ ";
	cp -p $SBIN_SOURCES $UPDIR/distrib/sbin
	echo "chmod 755 sbin/\*";
	chmod 755 $UPDIR/distrib/sbin/*

	# libexec
	echo " "; echo "Copying libexec/ ";
	cp .fmllocalrc 	$UPDIR/distrib/etc/dot_fmllocalrc
	cp -p $LIBEXEC_SOURCES $UPDIR/distrib/libexec

	# etc
	echo " "; echo "Copying etc/ ";
	cp -p $ETC_SOURCES $UPDIR/distrib/etc;
	tar cf - etc/makefml/Makefile etc/makefml/[0-9a-z]* |\
	(chdir $UPDIR/distrib; tar xvf - )

	# tar cf - etc/samples/[a-z]* | (chdir $UPDIR/distrib; tar xvf - )

	rm -f $archsrc
}


FIX_DISTRIBUTION_FILE_RCSID () {

	echo " ";
	echo "Fixing Rcsid ..."

   (cd kern	

	for file in fml.pl msend.pl 
	do
		echo "   Fixing Rcsid in $file ... ( > src/$file )"
		perl $FML/distrib/bin/fml_version.pl $file > $UPDIR/distrib/src/$file
	done

   )

	for file in $LIBEXEC_SOURCES 
	do
		echo "   Fixing Rcsid in $file ... "
		perl $FML/distrib/bin/fml_version.pl $file > $UPDIR/distrib/$file
	done
}


FIX_DISTRIBUTION_FILE_MAKEFILE () { 
	echo " "; echo "Fixing Makefile"

	# sed '/^DISTRIB/,$d' Makefile |\
	# sed '/^include/d'|\
	# sed 's/gar/rm \-f/' |\
	# sed 's/delete/rm \-f/' > $UPDIR/distrib/Makefile
}


MAKE_CONFIG_PH_EXAMPLE () {
	(echo "";echo -n " cf/release -> config.ph  "; date)
	cf/config cf/release > $UPDIR/distrib/config.ph
}


FIX_DISTIRUBTION_FILE_INCLUDE () {
	echo "---Including relations";
	echo "   libexec/fml_local.pl"
	$INCLUDE_PROG $UPDIR/distrib/libexec/fml_local.pl > /tmp/_fml$$_
	cp /tmp/_fml$$_ $UPDIR/distrib/libexec/fml_local.pl
	rm -f /tmp/_fml$$_
}



FIX_DISTRIBUTION_LINKS () {
   (
	echo "Arrangement of Links ... "
	cd $UPDIR/distrib;
	ln -s sbin/makefml makefml
   )


   (
	cd $UPDIR/distrib

	for file in README.jp README.en INSTALL.jp INSTALL.en
	do 
		ln -s doc/$file $file
	done
   )

	#cd $UPDIR/distrib/doc/drafts
	#for file in help guide deny objective confirm welcome 
	#do
	#	test -f $file && (chdir ../..; ln -s doc/drafts/$file $file)
	#done
}


GEN_CONTRIB () {

	for dir in `cat distrib/etc/contrib_list`
	do
		echo " "; 
		echo "---installing contrib/$dir"

		(cd contrib/$dir;\
		 make -f $FML/contrib/Makefile.template UPDIR=$UPDIR DISTRIB)

	done
}


FIX_DISTRIBUTION_PERMISSION () {
	echo " "
	echo "Fixing Permissions ..."

	find $UPDIR/distrib |\
	perl -nle '-d $_ && chmod(0755,$_); -f $_ && chmod(0644,$_)'

	find $HOME/.ftp/ |\
	perl -nle '-d $_ && chmod(0755,$_); -f $_ && chmod(0644,$_)'

	(
		cd $UPDIR/distrib
		chmod 755 src/fml.pl src/msend.pl bin/* sbin/* libexec/*
	)
}


PATCHLEVEL_INCREMENT () {
   ( 
	chdir $FML
	perl $FML/distrib/bin/fml_version.pl -p $PATCHLEVEL kern/$file |\
	perl -nple 's/(\$Rcsid.*pl\d+)pl(\d+)/sprintf("%s.%04d", $1, $2)/e' |\
	perl -nple 's/(\$Rcsid.*\#\d+)pl(\d+)/sprintf("%s.%04d", $1, $2)/e' \
	> $UPDIR/distrib/$target
   )
}


DISTRIBUTION_PATCHLEVEL_INCREMENT () {
	for file in fml.pl msend.pl
	do
		target=src/$file
		PATCHLEVEL_INCREMENT
	done

	for file in libexec/fmlserv.pl libexec/popfml.pl
	do
		target=$file
		PATCHLEVEL_INCREMENT
	done

}


FIX_LANGUATE () {
   (
	cd $UPDIR/distrib/drafts
	echo "Fixing Japanese code: "
	for file in *
	do
		echo -n "$file "
		nkf -j $file > $file.j
		mv $file.j $file
	done

	echo " ... Done."
   )
}


GEN_BRANCH_ARCHIVE () {
	chdir $UPDIR

	FMLID="fml-`sed 's/_//' $FML/etc/release_version`"
	DATE=`date +"%y%m%d"`
	FMLID=fml-SNAP$DATE

	echo mv distrib $FMLID
	mv distrib $FMLID

	set -vx

	tar cf $FMLID.tar $FMLID 
	gzip -9 $FMLID.tar
	find $FMLID |zip -q -@ $FMLID.zip

	set +vx
}

GEN_ARCHIVE () {
	# FIX_LANGUATE

	FTP=/usr/local/ftp/pub/net/fml-current
 	WWW=/home/hikari/sapporo/www/staff/fukachan/href/fml

	echo ""
	echo "rm -f $FTP/fml-2.1*gz $FTP/fml-current*gz"
	rm -f "$FTP/fml-2.1*gz $FTP/fml-current*gz"

	echo ""

	chdir $UPDIR

	FMLID="fml-`sed 's/_//' $FML/etc/release_version`"
	FMLID=`echo $FMLID| sed 's/\#/-snapshot/'`
	DATE=`date +%y%h%d`

	echo "Synchronizing $FTP/snapshot ..."
	echo " "
	test -d $FTP/snapshot || mkdir $FTP/snapshot;
	rsync --delete -av distrib/ $HOME/.ftp/snapshot/

	echo " Making snapshto/info for fml@eriko.sapporo.iij.ad.jp ... "
	echo " "
	echo "nkf -j $UPDIR/distrib/doc/INFO.jp => $FTP/snapshot/info"
	nkf -j $UPDIR/distrib/doc/INFO.jp > $FTP/snapshot/info

	echo "Synchronizing $WWW ..."
	echo " "
	echo rsync -av $FML/var/html/ $WWW/
	rsync -av $FML/var/html/ $WWW/

	echo " "
	echo "Unlinking *~ ..."
	echo " "
	find distrib -name '*~' -print|perl -nple unlink

	echo " "
	echo "Making tar.gz ...a "
	echo " "
	mv distrib $FMLID
	tar cvf $FMLID.tar $FMLID
	gzip -9 $FMLID.tar
	ln $FMLID.tar.gz fml-current.$DATE.tar.gz

	echo cp -p $FMLID.tar.gz $FTP
	cp -p $FMLID.tar.gz $FTP

	echo cp -p $FMLID.tar.gz $WWW/fml-current.tar.gz
	cp -p $FMLID.tar.gz $WWW/fml-current.tar.gz

	(
		echo 	chdir $FTP
		echo    rm -f fml-current.*.tar.gz
		echo 	ln $FMLID.tar.gz fml-current.$DATE.tar.gz
		echo 	ln $FMLID.tar.gz fml-current.tar.gz
		echo 	ln $FMLID.tar.gz old/$FMLID.tar.gz

		chdir $FTP
		rm -f fml-current.*.tar.gz fml-current.tar.gz
		ln $FMLID.tar.gz fml-current.$DATE.tar.gz
		ln $FMLID.tar.gz fml-current.tar.gz
		ln $FMLID.tar.gz old/$FMLID.tar.gz
		(uuencode fml-current.$DATE.tar.gz fml-current.$DATE.tar.gz)|\
		cat > $FTP/fml-current.uu
	)


	echo "Generating $FMLID.zip";
	find $FMLID |zip -q -@ $FMLID.zip
	(
		echo 	chdir $FTP
		chdir $FTP

		echo 	rm -f *.zip
		rm -f *.zip
	)

	cp -p $FMLID.zip $FTP

	(
		echo 	chdir $FTP
		echo 	ln $FMLID.zip fml-current.zip

		chdir $FTP
		ln $FMLID.zip fml-current.zip
	)

	#	echo "Generating ls-lR.gz";
	#	(
	#		chdir $FTP
	#		ls -lR . | gzip -9 > ls-lR.gz
	#	)

	(
		echo "Creating MD5"
		chdir $FTP

		md5 *gz *zip |sort |tee MD5SUM
	)
}
