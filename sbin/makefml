#!/usr/local/bin/perl
# Copyright (C) 1993-1996 fukachan@phys.titech.ac.jp
# Copyright (C) 1996-1997 fukachan@sapporo.iij.ad.jp
# fml is free software distributed under the terms of the GNU General
# Public License. see the file COPYING for more details.

local($id);
$id = q$Id$;
$rcsid .= " :".($id =~ /Id: lib(.*).pl,v\s+(\S+)\s+/ && $1."[$2]");


### AUTOMATICALLY REPLACED (Agent-Oriented?) ###
$CONFIG_DIR = ''; # __MAKEFML_AUTO_REPLACED_HERE__


&InitMakeFml;
&InitTTY;

&MakeFmlLock;

if (@ARGV) {
    &ExecCmd(join(" ",@ARGV));
}
else {
    &ExecCmd("info");
}

# RESERVED FOR FURTHER EXTENTION;
# Interactive Mode;
# &Menu;

&MakeFmlUnLock;

if ($GroupWritable) {
    print STDERR "\n   Please check the group permission in $MLDir\n";
    print STDERR "   Enjoy Internetworking!\n";
}

exit 0;



#################### LIBLARIES ####################
sub InitMakeFml
{
    &GetTime;

    require 'getopts.pl';
    &Getopts("dhf:A:");

    # flush;
    select(STDOUT); $| = 1;

    # flock(2)
    $LOCK_SH                       = 1;
    $LOCK_EX                       = 2;
    $LOCK_NB                       = 4;
    $LOCK_UN                       = 8;

    # umask 077?
    # if a group mainteints the fml system, umask(007)?;
    umask(002);

    $COMPAT_ARCH = $opt_A;

    if ($COMPAT_ARCH eq "WINDOWS_NT4") {
	$USER = $ENV{'USERNAME'};
    }
    else {
	$USER = $ENV{'USER'} || (getpwuid($<))[0];
    }

    $debug = $opt_d;

    $HOME  = $ENV{'HOME'};
    $PWD   = $ENV{'PWD'};

    { # DNS AutoConfigure to set FQDN and DOMAINNAME; 
	local(@n, $hostname, $list);
	chop($hostname = `hostname`); # beth or beth.domain may be possible
	$FQDN = $hostname;
	@n    = (gethostbyname($hostname))[0,1]; $list .= " @n ";
	@n    = split(/\./, $hostname); $hostname = $n[0]; # beth.dom -> beth
	@n    = (gethostbyname($hostname))[0,1]; $list .= " @n ";

	foreach (split(/\s+/, $list)) { /^$hostname\.\w+/ && ($FQDN = $_);}
	$FQDN       =~ s/\.$//; # for e.g. NWS3865
	$DOMAINNAME = $FQDN;
	$DOMAINNAME =~ s/^$hostname\.//;
    }

    # architecture dependence;
    if ($COMPAT_ARCH eq "WINDOWS_NT4") {
	$CONFIG_DIR =~ s#\\#/#g;
    }

    # config amd temporary files
    $CONFIG_LOG  = "/tmp/.fmlconfiglog.$USER";
    $CONFIG_DIR   = $CONFIG_DIR || "$HOME/.fml";

    if ($opt_f) {
	$FML_CONFIG  = $opt_f;	
    }
    else {
	$FML_CONFIG  = "$CONFIG_DIR/system";
    }

    # initialize files
    if (-f $FML_CONFIG) {
	print STDERR "---Loading the configuration file $FML_CONFIG\n\n";

	package Config;
	eval("require \$main'FML_CONFIG;\#'");
	print STDERR $@ if $@;

	$main'debug = $Config'debug;
	package main;

	&Dumpvar('Config') if $debug;
    }
    else {
	print STDERR "---ignore no configuration file $FML_CONFIG\n\n";
	$TheFirstTime = 1;
    }

    # if not defined this machine OS;
    if ($OS_TYPE = $Config'OS_TYPE{$FQDN}) { #';
	print "---THIS HOST ($FQDN)'s OS IS $OS_TYPE\n";
    }
    elsif ($COMPAT_ARCH eq "WINDOWS_NT4") {
	$OS_TYPE = "WINDOWS_NT4";
	eval("\$Config'OS_TYPE{'$FQDN'} = '$OS_TYPE';");
    }
    else {
	print "---Try to inspect your Operating System ...\n\n";
	local($eval);

	$eval = q#$OS_TYPE = `sh sbin/os-type`;#;
	eval($eval);

	print STDERR $@ if $@;
	print "\n";

	chop $OS_TYPE;
	$OS_TYPE =~ tr/a-z/A-Z/;

	print "   Your OS looks $OS_TYPE\n";
	print "\n";

	eval("\$Config'OS_TYPE{'$FQDN'} = '$OS_TYPE';");
    }


    # configurable variables;
    @Config = ('DOMAIN', 'FQDN', 'EXEC_DIR', 'ML_DIR');

    %Config = ('EXEC_DIR', 'EXEC FILES DIRECTORY',
	       'ML_DIR',   'TOP LEVEL ML DIRECTORY', 
	       'DOMAIN',   'DOMAIN NAME', 
	       'FQDN',     'FQDN', 
	       ); 

    %Default = ('PERSONAL_OR_GROUP', 'personal',
		'EXEC_DIR', '/usr/local/fml',
		'ML_DIR',   '/var/spool/ml', 
		'DOMAIN',   $DOMAINNAME,
		'FQDN',     $FQDN,
		); 

    # $COMPAT_ARCH eq "WINDOWS_NT4"
    if ($COMPAT_ARCH eq "WINDOWS_NT4") {
	local($dir);
	chop($dir = `cd`);
	$dir =~ s/(\w:).*/$1/;
	$Default{'EXEC_DIR'} = "$dir\\fml";
	$Default{'ML_DIR'}   = "$dir\\fml\\ml";
    }

    %MakeFmlProc = ('init',     'do_init',
		    'install',  'do_install',
		    '0#install', 'Install the fml system',
		    'info',     'do_info',
		    '0#info',    'show this message',
		    'setq',     'do_setq',
		    'show',     'do_show',
		    'config',   'do_config',
		    'new',      'do_newml',
		    'newml',    'do_newml',
		    '1#newml ML',   'make a new Mailing List <ML>',
		    'add',      'do_adduser',
		    '2#add ML address',     'add <address> to <ML>',
		    'adduser',  'do_adduser',
		    '2#adduser ML address', 'add <address> to <ML>',
		    'bye',      'do_byeuser',
		    '3#bye ML address',     'remove <address> from the <ML>',
		    'byeuser',  'do_byeuser',
		    '3#byeuser ML address', 'remove <address> from the <ML>',
		    'addadmin', 'do_addadmin',
		    '4#addadmin ML address', 'add <address> as an admin to <ML>',
		    'byeadmin', 'do_byeadmin',
		    '4#byeadmin ML address', 'remove the administrator of the <ML>',
		    'help',	'do_help',
		    '8#help',	'help message',
		    'passwd',	'do_passwd',
		    '8#passwd ML address',	'to change the administrator passwd',

		    'fmlserv',  'do_fmlserv',
		    'listserv', 'do_fmlserv',
		    'marjodomo','do_fmlserv',

		    '10#fmlserv', 'set up fmlserv (listserv-like interface)',
		    '10#listserv','set up fmlserv (listserv-like interface)',
		    '10#majordomo','set up fmlserv (listserv-like interface)',
		    );

    ### anyway reload and set the present config for convenience;
    &GetCurConfig;
    &ResetVariables;

    # fix include path for *.pl
    push(@INC, $ExecDir);

    if ($CurConfig{'PERSONAL_OR_GROUP'} eq 'group') {
	$GroupWritable = 1;
    }

    ### signal handling
    $SIG{'ALRM'} = 'TimeOut';
    $SIG{'INT'} = $SIG{'QUIT'} = $SIG{'TERM'} = 'SignalLog';
}


sub InitFmlConfig
{
    local($cmd, $prompt, $v);

    print "---Please Define Your Fml System Configurations\n\n";

    # personal or group-shared?
    printf "%-25s ", 'Personal Use? or ML-Admin-Group-Shared?';
    $cmd = &Query("Personal or Group ", "personal/group", 
		  "personal|group", "personal");    
    $cmd = ($cmd !~ /^\s*$/) ? $cmd : $v;
    &do_setq("PERSONAL_OR_GROUP", $cmd);

    # values;
    for (@Config) {
	$k = $_;
	$p = $Config{$_};
	$v = $CurConfig{$_} ? $CurConfig{$_} : $Default{$_};

	printf "%-25s %s ", $p, "[$v]";

	$cmd = &GetString;
	
	$cmd = ($cmd !~ /^\s*$/) ? $cmd : $v;
	$buf .= sprintf("  set \$%-10s = '%s';\n", $k, $cmd);
	&do_setq($k, $cmd);
    }

    print "\n$buf\n";

    &GetCurConfig;

    # print "CONFIG_DIR (e.g. $HOME/.fml, $CurConfig{'EXEC_DIR'}/.fml ...)\n";
    # print "Config Saved in [$CurConfig{'EXEC_DIR'}/.fml] ";
    # $cmd = &GetString;
    # $cmd = ($cmd !~ /^\s*$/) ? $cmd : "$CurConfig{'EXEC_DIR'}/.fml";
    # $CONFIG_DIR = $cmd;

    $CONFIG_DIR = "$CurConfig{'EXEC_DIR'}/.fml";

    # mkdir CONFIG_DIR;
    {
	local($dir);
	for (split(/\//, $CONFIG_DIR)) {
	    if ($COMPAT_ARCH eq "WINDOWS_NT4") {
		$dir .= $dir ? "/$_" : $_;
	    }
	    else {
		$dir .= "/$_";
	    }

	    $dir =~ s#//#/#g;

	    if (! -d $dir) {
		print "   mkdir $dir\n";
		mkdir($dir, 0755);
	    }
	}
    }

    $FML_CONFIG  = "$CONFIG_DIR/system";

    $buf = &Dumpvar('Config');
    &SaveConfig($buf);

    print "\nThe Current Config is saved in $FML_CONFIG\n";
}


sub GetCurConfig
{
    local($s);

    # reset %CurConfig from Config Name Space;
    for (keys %Default) { 
	$s .= "\$CurConfig{'$_'} = \$Config'$_;\n";
    }

    eval($s);
    print "$@\n---\n$s\n" if $@;
}


sub SaveConfig
{
    local($buf) = @_;

    if (-f $FML_CONFIG) { rename($FML_CONFIG, "${FML_CONFIG}.bak");}

    open(F, ">> $FML_CONFIG") || die("Cannot save config to $FML_CONFIG");
    select(F); $| = 1; select(STDOUT);
    print F "$buf\n";
    print F "\n1;\n";
    close(F);
}


sub FlushLog
{
    &Cat($CONFIG_LOG);
    unlink $CONFIG_LOG;
}


sub Cat
{
    local($in) = @_;

    open(IN, $in) || return;
    select(STDOUT); $| = 1;
    while (<IN>) { print $_;}
    close(IN); 
}


sub Copy
{
    local($in, $out) = @_;

    open(IN,  $in)      || (&Log("CopyIN: $!"), return);
    open(OUT, "> $out") || (&Log("CopyOUT: $!"), return);
    select(OUT); $| = 1; select(STDOUT); 
    while (sysread(IN, $_, 4096)) { print OUT $_;}
    close(OUT);
    close(IN); 
}


sub AppendString2File
{
    local($s, $file) = @_;

    open(APP, ">> $file") || return 0;
    select(APP); $| = 1; select(STDOUT);
    print APP "$s\n" if $s;
    close(APP);
}


sub Warn { print STDERR @_; print STDERR "\n";}


sub Log 
{ 
    &AppendString2File($_[0], $CONFIG_LOG);
}


sub SignalLog 
{ 
    local($sig) = @_; 
    print STDERR "Caught Signal[$sig], shutting down ... \n\n";
    #&FlushLog;
    exit(1);
}


sub MakeFmlLock
{
    local($dir) = $CurConfig{'ML_DIR'};

    print "\n---Try to LOCK ML Actions...\n\t";

    opendir(DIRD, $dir);
    for (readdir(DIRD)) {
	next if /^\./;
	next unless -f "$dir/$_/config.ph";
	$count++;
	print " $_";

	$FP_SPOOL_DIR = "$dir/$_/spool";
	open($FP_SPOOL_DIR, $FP_SPOOL_DIR);
	flock($FP_SPOOL_DIR, $LOCK_EX);

    }
    closedir(DIRD);

    if ($count) {
	print "\n   ALL ML ACTIONS ARE LOCKED; GO AHEAD!\n\n";
    }
    else {
	print "\n   NO ML EXISTS; GO AHEAD!\n\n";
    }
}


sub MakeFmlUnLock
{
    local($dir) = $CurConfig{'ML_DIR'};

    opendir(DIRD, $dir);
    for (readdir(DIRD)) {
	next if /^\./;

	$FP_SPOOL_DIR = "$dir/$_";
	open($FP_SPOOL_DIR, $FP_SPOOL_DIR);
	flock($FP_SPOOL_DIR, $LOCK_UN);

    }
    closedir(DIRD);
}


# lock algorithm using flock system call
# if lock does not succeed,  fml process should exit.
sub Flock
{
    open(LOCK, $FP_SPOOL_DIR); # spool is also a file!
    flock(LOCK, $LOCK_EX);
}


sub Funlock 
{
    close(LOCK);
    flock(LOCK, $LOCK_UN);
}


sub InitTTY
{
    if (-e "/dev/tty") { $console = "/dev/tty";}

    open(IN, "<$console") || open(IN,  "<&STDIN"); # so we don't dingle stdin
    open(OUT,">$console") || open(OUT, ">&STDOUT");# so we don't dongle stdout
    select(OUT); $| = 1; #select(STDOUT); $| = 1;
}


sub ExecCmd
{
    local($_) = @_;
    local(@argv, $fp);

    @argv = split(/\s+/, $_);

    &GetCurConfig;
    &ResetVariables;

    if ($TheFirstTime) {
	;
    }
    else {
	if (!-d $ExecDir) {
	    print STDERR "ExecDir($ExecDir) NOT FOUND, STOP\n";
	    return;
	}
	if (!-d $MLDir) {
	    print STDERR "MLDir($MLDir) NOT FOUND, STOP\n";
	    return;
	}
    }



    # function pointer;
    $fp = shift @argv;
    $fp = $FP{$fp} ? $FP{$fp} : $fp;

    if ($MakeFmlProc{$fp}) {
	$fp = $MakeFmlProc{$fp};
	&$fp(@argv);
    }
    else {
	print "   Command [$fp] NOT DEFINED\n";
	print "   Please see the document 'INSTALL'\n\n";
	return;
    }

}


sub gets
{
    local($.);
    $_ = <IN>;
}


sub GetString
{
    local($s);

    $s = &gets;

    # ^D
    if ($s eq "")  { exit 0;}
    chop $s;

    $s;
}


sub FixPath
{
    local($prog) = @_;
    local($perl);

    if ($COMPAT_ARCH eq "WINDOWS_NT4") { 
	$perl = "";
    }
    else {
	$perl = &search_path('perl');
    }

    open(IN, $prog) || (&Warn("cannot open $prog"), return);
    open(NEW, "> $prog.new") || (&Warn("cannot open $prog.new"), return);
    select(NEW); $| = 1; select(STDOUT);

    while (<IN>) {
	if ($. == 1) {
	    print NEW "\#\!$perl\n" if $perl;
	    next;
	}

	next if /^\#\#\# AUTOMATICALLY REPLACED/;

	# recreate my own;
	if ($prog =~ /makefml/ && 
	    /__MAKEFML_AUTO_REPLACED_HERE__/ && /^\$CONFIG_DIR/) {
	    print STDERR "-----Replace makefml::\$CONFIG_DIR -> $CONFIG_DIR\n";
	    print NEW "### AUTOMATICALLY REPLACED by makefml ($MailDate)\n";
	    print NEW "\$CONFIG_DIR = '$CONFIG_DIR'; ";
	    print NEW "\# __MAKEFML_AUTO_REPLACED_HERE__\n";
	    next;
	}

	print NEW $_;
    }
    close(NEW);
    close(IN);
    sleep 1;

    if ($COMPAT_ARCH eq "WINDOWS_NT4") { 
	unlink "${prog}.bak" if -f "${prog}.bak";
	&Copy($prog, "${prog}.bak");
	&Copy("${prog}.new", $prog);
    }
    else {
	rename($prog, "${prog}.bak") || &Warn("cannot rename $prog $prog.bak");
	rename("${prog}.new", $prog) || &Warn("cannot rename $prog.new $prog");
    }
}


sub search_path
{
    local($f) = @_;
    local($path) = $ENV{'PATH'};
    local(@path) = split(/:/, $path);

    for ("/usr/local/bin", "/usr/share/bin", 
	 "/usr/contrib/bin", "/usr/gnu/bin") {
	push(@path, $_);
    }

    foreach $dir (@path) { if (-f "$dir/$f") { return "$dir/$f";}}
}


sub OutPutLocalConfig
{
    local(*MAKE_FML) = @_;

    print CF "\nLOCAL_CONFIG\n\n";
    print CF "\#__MAKEFML_LOCAL_CONFIG__\n";
    print CF "require 'libmakefml.pl';\n";

    for (keys %MAKE_FML) {
	$value = $MAKE_FML{$_};
	$value = ($value =~ /^\d+$/) ? $value : "\"$value\"";
	print CF "\$MAKE_FML{'$_'} = $value;\n";
    }

    print CF "&ConfigByMakeFml;\n";
    print CF "\#__END_OF_MAKEFML_LOCAL_CONFIG__\n";
}



sub Query
{
    local($menu, $query, $pat, $default) = @_;
    
    print "\n";

    while (1) {
	#print "menu={$menu} query={$query}\n";
	print "${CurTag}${menu} ($query) [$default] ";
	$cmd = &GetString;
	print "\n";

	if ($cmd =~ /^($pat)$/) { last;}
	if ($cmd =~ /^\s*$/) { $cmd = $default; last;}

	print "$CurTag   ***Warning!!! Please input ($query)\n";
    }    

    $cmd;
}


sub ShowMainMenu
{
    local(*config, *MAKE_FML) = @_;

    eval($local_config);
    print $@ if $@;

    if ($config{'ML_MEMBER_CHECK'}) {
	$ShowMenu{'auto_regist'} = "member_check";
    }
    else {
	$ShowMenu{'auto_regist'} = "auto_registation";
    }

    &MakeOptionShowMenu(*MAKE_FML);

    $MENU = qq#;
    ********************************************************************;
    Which entry do you change?;
    --------------------------------------------------------------------;
      ENTRY                                   Current Configuration
    --------------------------------------------------------------------;
    ;
    0 END;
    1 MEMBER CHECK or AUTO REGISTRATION        $ShowMenu{'auto_regist'};
    2 SUBJECT TYPE                             $MAKE_FML{'SUBJECT_TAG'};
    3 OPTIONAL SETTINGS(e.g. MIME, HTML)       $ShowMenu{'option_summary'};
    ;
    ;#;

    $MENU =~ s/;//g;

    print $MENU;
}


sub AutoRegistQuery
{
    local($ml, *config) = @_;
    local($r, *new);

    ### MENU;
    undef $MENU{'AUTO_REGIST_TYPE'};
    $MENU{'AUTO_REGIST_TYPE'} .= "\n";
    $MENU{'AUTO_REGIST_TYPE'} .= "Auto Registration Type\n";
    $MENU{'AUTO_REGIST_TYPE'} .= "0 default\n";
    $MENU{'AUTO_REGIST_TYPE'} .= "1 subject\n";
    $MENU{'AUTO_REGIST_TYPE'} .= "2 body\n";	
    $MENU{'AUTO_REGIST_TYPE'} .= "\n";
    $MENU{'AUTO_REGIST_TYPE'} =~ s/\n/\n$CurTag/g;
    ### END MENU;

    ### DEFAULT CONFIG; 
    $new{'ML_MEMBER_CHECK'}           = 0;
    $new{"REQUIRE_SUBSCRIBE"}         = "";
    $new{"REQUIRE_SUBSCRIBE_IN_BODY"} = "";
    push(@config, (sort keys %new));
    ### END CONFIG; 

    # MAIN;
    $r = &Query("Auto Registration ", "y/n", "y|n", "n");
    $new{'ML_MEMBER_CHECK'} = $r eq 'y' ? 0 : 1;

    if ($r eq "y") {
	print $MENU{'AUTO_REGIST_TYPE'};

	$r = &Query("Auto Registration Type ", "0,1,2 ", '0|1|2', "0");

	if ($r == 1) {
	    $new{"REQUIRE_SUBSCRIBE"}         = "subscribe";
	}
	elsif ($r == 2) {
	    $new{"REQUIRE_SUBSCRIBE"}         = "subscribe";
	    $new{"REQUIRE_SUBSCRIBE_IN_BODY"} = 1;
	}
    }

    # reset;
    for (keys %new) {
	undef $config{$_};
	$config{$_} = $new{$_};
    }
}


sub SubjectTagQuery
{
    local($ml, *MAKE_FML) = @_;
    local($r, $buf);

    undef $MAKE_FML{"SUBJECT_TAG"};
    $MENU{"SUBJECT_TAG"} .= "\n";
    $MENU{"SUBJECT_TAG"} .= "Subject TAG TYPE [0-6]:\n\n";
    $MENU{"SUBJECT_TAG"} .= "TYPE    Subject Example\n";
    $MENU{"SUBJECT_TAG"} .= "----------------------------\n";
    $MENU{"SUBJECT_TAG"} .= "0\tSubject: NO TAG (Default, Fml recommends)\n";
    $MENU{"SUBJECT_TAG"} .= "\n";
    $MENU{"SUBJECT_TAG"} .= "1\tSubject: (Elena:100)\n";
    $MENU{"SUBJECT_TAG"} .= "\n";
    $MENU{"SUBJECT_TAG"} .= "2\tSubject: [Elena:100]	(hml 1.6 compat)\n";
    $MENU{"SUBJECT_TAG"} .= "\n";
    $MENU{"SUBJECT_TAG"} .= "3\tSubject: (Elena 100)\n";
    $MENU{"SUBJECT_TAG"} .= "\n";
    $MENU{"SUBJECT_TAG"} .= "4\tSubject: [Elena 100]\n";
    $MENU{"SUBJECT_TAG"} .= "\n";
    $MENU{"SUBJECT_TAG"} .= "5\tSubject: [Elena,100]\n";
    $MENU{"SUBJECT_TAG"} .= "\n";
    $MENU{"SUBJECT_TAG"} .= "6\tSubject: (Elena,100)\n";
    $MENU{"SUBJECT_TAG"} .= "\n";

    $MENU{'SUBJECT_TAG'} =~ s/\n/\n$CurTag/g;

    print $MENU{'SUBJECT_TAG'};

    $r = &Query("Subject TAG TYPE ", "0-6", "[0-6]", "0");

    %tag = (1, "(:)",
	    2, "[:]",
	    3, "( )",
	    4, "[ ]",
	    5, "(,)",
	    6, "[,]");

    if ($r =~ /^[123456]$/) {
	$MAKE_FML{"SUBJECT_TAG"} =  "$tag{$r}";
    }
}


sub MakeOptionShowMenu
{
    local(*MAKE_FML) = @_;
    local($r, $buf);

    for (keys %MAKE_FML) {
	next unless /^OPT_/;
	next if $MAKE_FML{$_} != 1;

	$_ =~ s/OPT_//;
	$r .= $r ? ",$_" : $_;
    }

    $ShowMenu{'OPT_MIME'} = $MAKE_FML{'OPT_MIME'} == 1 ? "USE": "";
    $ShowMenu{'OPT_HTML'} = $MAKE_FML{'OPT_HTML'} == 1 ? "USE": "";

    $ShowMenu{'option_summary'} = $r;
}


sub ShowOptionMenu
{
    local(*MAKE_FML) = @_;

    &MakeOptionShowMenu(*MAKE_FML);
    
    $MENU{'OPTIONS'}  = "\n";
    $MENU{'OPTIONS'} .= "OPTIONS\n";
    $MENU{'OPTIONS'} .= "\n";
    $MENU{'OPTIONS'} .= "------------------------------------\n";
    $MENU{'OPTIONS'} .= "  ENTRY                Current Configuration\n";
    $MENU{'OPTIONS'} .= "------------------------------------\n";
    $MENU{'OPTIONS'} .= "0 END\n";
    $MENU{'OPTIONS'} .= "1 MIME                 $ShowMenu{'OPT_MIME'}\n";
    $MENU{'OPTIONS'} .= "2 HTML CONVERSION      $ShowMenu{'OPT_HTML'}\n";
    $MENU{'OPTIONS'}  =~ s/\n/\n$CurTag/g;

    print $MENU{'OPTIONS'};
}


sub OptionQuery
{
    local($ml, *MAKE_FML) = @_;
    local($r, $buf);

    ### MAIN ###
    while (1) {
	&ShowOptionMenu(*MAKE_FML);

	$tag = $CurTag;
	$CurTag .= "   ";
	$r = &Query("OPTIONS ", "1-2", "[1-2]", "0");

	$CurTag .= "   ";

	if ($r == 0) {
	    last;
	}
	elsif ($r == 1) {
	    $r = &Query("USE MIME", "y/n", "y|n", "n");
	    $MAKE_FML{"OPT_MIME"} = $r eq "y" ?  1 : 0;
	}
	elsif ($r == 2) {
	    $r = &Query("USE HTML", "y/n", "y|n", "n");
	    $MAKE_FML{"OPT_HTML"} = $r eq "y" ?  1 : 0;
	}

	$CurTag = $tag;
    }
}


sub ResetVariables
{
    # anyway set;
    &GetCurConfig;

    if ($COMPAT_ARCH eq "WINDOWS_NT4") {
	$USER = $ENV{'USERNAME'};
    }
    else {
	$USER    = (getpwuid($<))[0];
    }

    $ExecDir = $CurConfig{'EXEC_DIR'};
    $MLDir   = $CurConfig{'ML_DIR'};
    $DOMAIN  = $CurConfig{'DOMAIN'};
    $FQDN    = $CurConfig{'FQDN'};

    if ($CurConfig{'PERSONAL_OR_GROUP'} eq 'group') {
	$GroupWritable = 1;
    }
    else {
	$GroupWritable = 0;	
    }

    # Mailing list name is all lower case;
    # $ml =~ tr/A-Z/a-z/;

    if (-f "$MLDir/$ml") {
	die("Cannot find $ml. you've not created it yet?\n");
    }

    $ML_ETC_DIR = "$MLDir/etc";
}


sub GenCrontab
{
    local($uid);

    print STDERR "\n";
    print STDERR "   Crontab for all ${USER}'s ML's is saved in\n";
    print STDERR "   $ML_ETC_DIR/crontab/$USER\n";

    open(TAB, "> $ML_ETC_DIR/crontab/$USER") || 
	(&Warn("cannot open $ML_ETC_DIR/crontab/$USER"), return);
    select(TAB); $| = 1; select(STDOUT);

    opendir(DIRD, $MLDir) || (&Warn("cannot open $MLDir"), return);
    for (readdir(DIRD)) {
	next if /^\./;

	$uid = (stat("$MLDir/$_/crontab"))[4];

	# if $uid == real-UID;
	if (($uid == $<) && -f "$MLDir/$_/crontab") {
	    if (open(IN, "$MLDir/$_/crontab") ) {
		while (<IN>) { print TAB $_;}
		close(IN);
	    }
	}

    }
    closedir(DIRD);

    close(TAB);
}


sub Repl
{
    local($member, $file) = @_;

    open(F, $file)           || (&Warn("cannot open $file"), return 0);
    open(NEW, "> $file.new") || (&Warn("cannot open $file.new"), return 0);
    select(NEW); $| = 1; select(STDOUT);

    while (<F>) {
	/^$member/ && $found++;
	s/^\#\s*$member/\#\#BYE $member/i; # off;
	s/^$member/\#\#BYE $member/i;
	print NEW $_;
    }

    close(NEW);
    close(F);

    rename($file, "${file}.bak") || 
	(&Warn("cannot rename $file $file.bak"), return 0);
    rename("${file}.new", $file) ||
		(&Warn("cannot rename $file.new $file"), return 0);

    $found;
}


sub Mesg { print STDERR "$_[1]\n";}


sub Conv
{
    local($ml, $example, $out) = @_;
    local($uid, $gid);
    open(IN, $example)  || &Log("cannot open $example");
    open(CF, "> $out")   || &Log("cannot open $out");
    select(CF); $| = 1; select(STDOUT);
    
    print STDERR "\tGenerating $out\n";

    if ($COMPAT_ARCH eq "WINDOWS_NT4") {
	$USER = $ENV{'USERNAME'};
    }
    else {
	$uid   = $uid || (getpwuid($<))[2];
	$gid   = $gid || (getpwuid($<))[3];
    }

    while (<IN>) {
	s/_EXEC_DIR_/$ExecDir/g;
	s/_ML_DIR_/$MLDir/g;
	s/_ML_/$ml/g;
	s/_DOMAIN_/$DOMAIN/g;
	s/_FQDN_/$FQDN/g;
	s/_USER_/$USER/g;
	s/_OPTIONS_/$opts/g;
	s/XXUID/$uid/g;
	s/XXGID/$gid/g;
	print CF $_;
    }

    close(IN);
    close(CF);
}


sub Touch  { open(APPEND, ">> $_[0]"); close(APPEND);}

sub GetTime
{
    @WDay = ('Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat');
    @Month = ('Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
	      'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec');
    
    ($sec,$min,$hour,$mday,$mon,$year,$wday) = (localtime(time))[0..6];
    $Now = sprintf("%2d/%02d/%02d %02d:%02d:%02d", 
		   $year, $mon + 1, $mday, $hour, $min, $sec);
    $MailDate = sprintf("%s, %d %s %d %02d:%02d:%02d %s", 
			$WDay[$wday], $mday, $Month[$mon], 
			$year, $hour, $min, $sec, $TZone);

    # /usr/src/sendmail/src/envelop.c
    #     (void) sprintf(tbuf, "%04d%02d%02d%02d%02d", tm->tm_year + 1900,
    #                     tm->tm_mon+1, tm->tm_mday, tm->tm_hour, tm->tm_min);
    # 
    $CurrentTime = sprintf("%04d%02d%02d%02d%02d", 
			   1900 + $year, $mon + 1, $mday, $hour, $min);
}


sub FixIncludeHeader
{
    local($file, $include, @include, $INCDIR);

    $include =q#sys/types.h unistd.h#;
    @include = split(/\s+/, $include);
    $INCDIR  = '/usr/include';

    &ResetVariables;

    print STDERR "\tGenerating $MLDir/$ml/config.h\n";

    if (open(GUESS, "> $MLDir/$ml/config.h")) {
	foreach $file (@include) {
	    if ( -f "$INCDIR/$file" ) {
		print GUESS "\#include <$file>\n";
	    }
	    else {
		# print STDERR "Not Found $INCDIR/$file\n";
	    }
	}

	close(GUESS);
    }
}


#################################################################
sub do_help
{
    print "makefml:\n";
    print "   available commands\nt";
    print join("\n\t", (keys %MakeFmlProc));
    print "\n\n";
}


sub do_passwd
{
    local($ml, $member, $passwd) = @_;
    local($passwd_file);

    umask(022);

    print "---Changing Passwd of Admin $member in $ml mailing list\n";

    &ResetVariables;

    # $ml/etc
    -d "$MLDir/$ml/etc" || mkdir("$MLDir/$ml/etc", 0755);
    $passwd_file= "$MLDir/$ml/etc/passwd";

    -f $passwd_file || &Touch($passwd_file);

    while (!$member || !$passwd) {
	if (! $member) {
	    print "Address: ";
	    chop($member = <STDIN>);
	}
	else {
	    print "Address: $member\n";
	}

	if (! $passwd) {
	    # no echo
	    system "stty", "-echo";

	    print "Password: ";
	    chop($passwd = <STDIN>);
	    print "\n";

	    system "stty", "echo";
	}

	if (!$member || !$passwd) {
	    &Warn("Error: Please input NOT NULL Address and Password.");
	}
    }

    require 'libcrypt.pl';
    $init = 1;	# if new-comer, initialize the passwd;

    print "\n";

    if (&ChangePasswd($passwd_file, $member, $passwd, $init)) {
	print "   Passwd Changed ($passwd_file).\n";
    }
    else {
	print "   Passwd Change Fails ($passwd_file).\n";
    }

}


sub do_init
{
    &ResetVariables;

    if (! -d $ExecDir) {
	print "   mkdir $ExecDir\n";
	mkdir($ExecDir, 0755);		
    }

    if (! -d $MLDir) {
	if ($GroupWritable) {
	    mkdir($MLDir, 0775);
	a}
	else {
	    mkdir($MLDir, 0755);
	}
    }

    print "\n";
}


sub do_info
{
    print STDERR "*" x 60; print STDERR "\n";
    print STDERR "makefml Usage:\n\n";

    printf STDERR "   makefml %-20s %s\n", "command arguments", "what";
    print STDERR "   ".("-"x57)."\n\n";

    for (sort {$a <=> $b} keys %MakeFmlProc) {
	next unless /^\d+\#/;
	$usage = $MakeFmlProc{$_};

	s/^(\d+\#)//;

	printf STDERR "   makefml %-20s %s\n", $_, $usage;
    }

    print STDERR "\n";
    print STDERR "*" x 60; print STDERR "\n";
    print STDERR "\n";
    print STDERR "HOW TO INSTALL:\n";
    print STDERR "Please input \"perl makefml install\" to INSTALL the fml\n";
    print STDERR "\n";
}


sub do_install
{
    local($cmd);

    # main proc -> here;
    &InitFmlConfig;
    &ExecCmd("init");

    print "---Install the Fml system to $CurConfig{'EXEC_DIR'}. O.K.? y/n [n] ";
    $cmd = &GetString;

    if ($cmd ne 'y') {
	print "STOP. (DO NOT INSTALLED)\n";
	return;
    }
    else {
	print "\nInstalling ... to $Config'EXEC_DIR\n"; #';
    }

    &FixPath("src/fml.pl");
    &FixPath("src/msend.pl");
    &FixPath("libexec/fmlserv.pl");
    &FixPath("sbin/makefml");
    &FixPath("cf/config");

    &ResetVariables;

    # /var/spool/ml/etc/
    umask(002);
    if ($GroupWritable) {
	print STDERR "Group Writable\n" if $debug;
	print STDERR "mkdir $ML_ETC_DIR\n" if $debug;;
	-d $ML_ETC_DIR || mkdir($ML_ETC_DIR, 0775);
    }
    else {
	print STDERR "Personal Use\n" if $debug;;
	print STDERR "mkdir $ML_ETC_DIR\n" if $debug;;
	-d $ML_ETC_DIR || mkdir($ML_ETC_DIR, 0755);
    }

    # $ExecDir/sbin/install.sh is NOT yet installed 
    if ($COMPAT_ARCH eq "WINDOWS_NT4") {
	print "perl sys/arch/WINDOWS_NT4/ntinstall.pl $ExecDir\n";
	system "perl sys/arch/WINDOWS_NT4/ntinstall.pl $ExecDir";
    }
    elsif (-f "sbin/install.sh") {
	$SH = $ENV{'SH'} || "/bin/sh";
	system "$SH ./sbin/install.sh $ExecDir";
	eval symlink($CONFIG_DIR, "$ExecDir/Configurations");
    }
    else {
	print "Please do \"makefml\" in the top directory of the source\n";
    }
}


sub do_setq
{
    #print STDERR "setq \$Config'$_[0] = '$_[1]';\n"  if $debug;;
    eval("\$Config'$_[0] = '$_[1]';");
    print "$@\n--@_\n" if $@;
}


sub GenerateDirectory
{
    local($ml) = @_;

    ### umask;
    umask(002);

    &ResetVariables;

    ### mkdir ML Directory
    # group writable;
    if ($GroupWritable) {
	print STDERR "Group Writable\n"  if $debug;;
	print STDERR "mkdir etc crontab\n" if $debug;;
	-d $ML_ETC_DIR           || mkdir($ML_ETC_DIR, 0775);
	-d "$ML_ETC_DIR/crontab" || mkdir("$ML_ETC_DIR/crontab", 0775);
    }
    else {
	print STDERR "Personal Use\n" if $debug;;
	print STDERR "mkdir etc crontab\n" if $debug;;
	-d $ML_ETC_DIR           || mkdir($ML_ETC_DIR, 0755);
	-d "$ML_ETC_DIR/crontab" || mkdir("$ML_ETC_DIR/crontab", 0755);
    }

    # group read but not-write apermission;
    -d "$ML_ETC_DIR/$ml"     || mkdir("$ML_ETC_DIR/$ml", 0755);

    # owner only read-write
    # umask(077);
    -d "$MLDir/$ml"         || mkdir("$MLDir/$ml", 0755);
}


sub do_new { &do_newml(@_);}
sub do_newml
{
    local($ml) = @_;

    print "---Creating $ml mailing list\n";

    &GenerateDirectory($ml);
    &ResetVariables;

    ### cf file; 
    umask(022);

    #print STDERR "$ExecDir/cf/__makefml -> $MLDir/$ml/cf\n";
    &Conv($ml, "$ExecDir/cf/__makefml", "$MLDir/$ml/cf");

    if ($OS_TYPE && open(CF, ">> $MLDir/$ml/cf")) {
	$MAKE_FML{'NON_PORTABILITY'} = 1;
	$MAKE_FML{'OS_TYPE'} = $OS_TYPE;
	&OutPutLocalConfig(*MAKE_FML);
	close(CF);
    }

    &ResetVariables;

    # include file is public readable;
    # why for () fails?;
    &Conv($ml, "$ExecDir/etc/makefml/include", "$MLDir/$ml/include");
    &Conv($ml, "$ExecDir/etc/makefml/aliases", "$MLDir/$ml/aliases");
    &Conv($ml, "$ExecDir/etc/makefml/crontab", "$MLDir/$ml/crontab");
    &Conv($ml, "$ExecDir/etc/makefml/fml.c",   "$MLDir/$ml/fml.c");
    &FixIncludeHeader;

    &GenCrontab;

    # make ml/config.ph
    umask(077);

    $exec  = "perl $ExecDir/cf/config -m $ExecDir/cf/MANIFEST ";
    $exec .= "$MLDir/$ml/cf";
    system "$exec > $MLDir/$ml/config.ph";

    # the last info
    print "\n   Please see several examples in $MLDir/$ml\n";
    print "\n# Example of Aliases ($MLDir/$ml/aliases)\n";
    &Cat("$MLDir/$ml/aliases");
    print "\n";
}


sub do_config
{
    local($ml) = @_;

    local($cf, $local_config, $config);
    local(@config, %config);

    print "---Configure $ml mailing list ... \n";

    &ResetVariables;

    $cf = "$MLDir/$ml/cf";

    # GET PRESENT CONFIG;
    # without LOCAL_CONFIG;
    open(CF, $cf) || die ("cannot find $cf");
    while (<CF>) {
	next if /^\#/;
	next if /^\s*$/;
	chop;

	if (1 .. /LOCAL_CONFIG/) {
	    next if /^LOCAL_CONFIG/;
	    ($key, $value) = split(/\s+/, $_, 2);
	    $config{$key} = $value;
	    push(@config, $key);
	}
	else {
	    next if /^LOCAL_CONFIG/;

	    if (/^\#__MAKEFML_LOCAL_CONFIG__/ .. 
		/^\#__END_OF_MAKEFML_LOCAL_CONFIG__/) {
		$local_config .= $_ if /\$MAKE_FML/;
	    }
	}
    }

    # set local_config -> %MAKE_FML;
    print "====\n";
    print $local_config;
    print "=======\n";
    eval($local_config);
    print $@ if $@;


    ### MAIN ###
    while (1) {
	$CurTag = "    ";

	&ShowMainMenu(*config, *MAKE_FML);

	#($menu, $query, $pat, $default)
	$r = &Query("Menu ", "number", "\\d+", "0");

	$CurTag = "\t";  

	if ($r == 0) {
	    last;
	}
	elsif ($r == 1) {
	    &AutoRegistQuery($ml, *config);
	}
	elsif ($r == 2) {
	    &SubjectTagQuery($ml, *MAKE_FML);
	}
	elsif ($r == 3) {
	    &OptionQuery($ml, *MAKE_FML);
	}
    }


    # set local_config -> %MAKE_FML;
    print $local_config;
    $eval = q%eval $local_config;%;
    eval($eval);
    print $@ if $@;



    if (open(CF, "> $cf")) {
	select(CF); $| = 1; select(STDOUT);

	for (@config) {
	    # printf    "%-25s\t%s\n", $_, $config{$_};
	    printf CF "%-25s\t%s\n", $_, $config{$_};
	}

	$MAKE_FML{'NON_PORTABILITY'} = 1;
	$MAKE_FML{'OS_TYPE'}         = $OS_TYPE;
	&OutPutLocalConfig(*MAKE_FML);

	close(CF);

	print "Saved in $cf\n";
    }

    # make ml/config.ph
    $exec = "perl $ExecDir/cf/config $cf ";
    system "$exec > $MLDir/$ml/config.ph";
}


sub do_addadmin
{
    $AdminMode = 1;
    &do_adduser(@_);
    $AdminMode = 0;
}

sub do_byeadmin
{
    $AdminMode = 1;
    &do_byeuser(@_);
    $AdminMode = 0;
}

sub do_adduser
{
    local($ml, $member) = @_;
    local(@files);

    umask(077);

    print "---Adding $member to $ml mailing list\n";

    if ($AdminMode) {
	@files = ("$MLDir/$ml/members-admin");
    }
    else {
	@files = ("$MLDir/$ml/members", "$MLDir/$ml/actives");
    }

    &ResetVariables;

    # mkdir ML Directory
    if (! -d "$MLDir/$ml") {
	print "\n*****Error: $ml ML NOT CREATED\n";
	print "   Firstly,please do \"perl makefml newml $ml\"!\n";
	return;
    }

    # add 
    for (@files) {
	print "Append $member to $_\n" if $debug;
	&AppendString2File($member, $_);
    }
}


sub do_byeuser
{
    local($ml, $member) = @_;
    local(@files);

    print "---Delete $member in $ml mailing list\n";

    umask(077);


    if ($AdminMode) {
	@files = ("$MLDir/$ml/members-admin");
    }
    else {
	@files = ("$MLDir/$ml/members", "$MLDir/$ml/actives");
    }

    &ResetVariables;

    # mkdir ML Directory
    if (! -d "$MLDir/$ml") {
	print "***Error: $ml ML NOT CREATED\n";
	print "   Firstly,please do \"perl makefml newml $ml\"!\n";
	return;
    }

    # delete 
    for (@files) {
	if (&Repl($member, $_)) {
	    print "Delete $member in $_\n" if $debug;
	}
    }
}


sub do_fmlserv
{
    print "---Configure fmlserv mailing list ... \n";

    # special assigned ML;
    $ml = "fmlserv";

    &GenerateDirectory($ml);
    &ResetVariables;

    ### cf file; 
    umask(022);

    &ResetVariables;

    # include file is public readable;
    # why for () fails?;
    local($exec_dir) = "$ExecDir/etc/makefml";
    &Conv($ml, "$exec_dir/fmlserv-include", "$MLDir/$ml/include");
    &Conv($ml, "$exec_dir/fmlserv-aliases", "$MLDir/$ml/aliases");
    &Conv($ml, "$exec_dir/fmlserv-fml.c",   "$MLDir/$ml/fml.c");

    &FixIncludeHeader;

    &Copy("$ExecDir/doc/drafts/help-fmlserv", "$MLDir/fmlserv/help");

    # the last info
    print "\n   Please see several examples in $MLDir/$ml\n";
    print "\n# Example of Aliases ($MLDir/$ml/aliases)\n";
    &Cat("$MLDir/$ml/aliases");
    print "\n";

}


#################################################################
package dumpvar;

sub main'Dumpvar 
{
    ($package, @vars) = @_;

    if ($] =~ /5\.\d\d\d/) { 
	*stab = *{"${package}::"};
    }
    else {
	(*stab) = eval("*_$package");
    }

    while (($key, $val) = each(%stab)) {
	{
	    next if @vars && !grep($key eq $_,@vars);
	    local(*entry) = $val;

	    if (defined $entry) {
		$buf .= "\$$key = '$entry';\n";
	    }

	    if (defined @entry) {
		$buf .= "\@$key = (\n";
		foreach $num ($[ .. $#entry) {
		    $buf .= "  $num\t'",$entry[$num],"'\n";
		}
		$buf .= ");\n";
	    }

	    if ((($] !~ /5\.\d\d\d/) && 
		 $key ne "_$package" && $key ne "_DB" && defined %entry
		 )
		||
		(($] =~ /5\.\d\d\d/) && 
		 $key ne "$package::" && $key ne "DB::" && 
		 (defined %entry) && 
		 ($dumpPackages || $key !~ /::$/)
		 && ($key !~ /^_</ || $dumpDBFiles)
		 && !($package eq "dumpvar" && $key eq "stab")
		 )
		) {

		$buf .= "\%$key = (\n";
		foreach $key (sort keys(%entry)) {
		    $buf .= "\t '$key', '$entry{$key}', \n";
		}
		$buf .= ");\n";
	    }
	}
    }

    return $buf;
}

1;
